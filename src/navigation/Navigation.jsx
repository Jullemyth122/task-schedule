import React, { useEffect, useState } from 'react';
import { Link, useNavigate } from 'react-router-dom';  // Use useNavigate from React Router v6
import {  getAuth, signOut } from 'firebase/auth'; // Import Firebase auth
import { doc, getDoc } from 'firebase/firestore';
import { db } from '../utilities/firebase';

const Navigation = () => {
    const [user, setUser] = useState(null);
    const [notifications, setNotifications] = useState([]);
    const [showNotifs, setShowNotifs] = useState(false);
    const navigate = useNavigate();
  
    useEffect(() => {
        const auth = getAuth();
        const unsubscribe = auth.onAuthStateChanged((currentUser) => {
            if (currentUser) {
            setUser(currentUser);
            } else {
            setUser(null);
            }
        });
        return () => unsubscribe();
    }, []);
  
    useEffect(() => {
        if (user) {
            const fetchNotifications = async () => {
                try {
                    const docRef = doc(db, "account", user.uid);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        setNotifications(data.notifications || []);
                    }
                } catch (err) {
                    console.error("Error fetching notifications:", err);
                }
            };
            fetchNotifications();
        }
    }, [user]);
  
    const handleLogout = async () => {
        try {
            const auth = getAuth();
            await signOut(auth);
            localStorage.removeItem("user");
            navigate('/signup');
        } catch (error) {
            console.error("Error logging out:", error.message);
        }
    };
  
    const getColor = (status) => {
        switch (status) {
            case 'red':
            return '#ff4d4d';
            case 'orange':
            return '#ffa500';
            case 'green':
            return '#28a745';
            default:
            return '#888';
        }
    };

    return (
        <div className='navigator-comp w-full'>
            <ul className='flex items-center justify-between gap-3 h-full'>
                <div className="nav-side">
                    <h3 className='txt1'> T 4 S K </h3>
                    <h3 className='absolute txt2'> T 4 S K </h3>
                </div>
                <div className="nav-side flex items-center justify-evenly gap-5 px-5 m-0 h-full">
                    <Link className='nav-link' to={'/'}>
                        <svg width="20" height="19" viewBox="0 0 20 19" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M17.9401 7.50089C17.9401 7.36829 17.8874 7.24111 17.7936 7.14734C17.6999 7.05357 17.5727 7.00089 17.4401 7.00089C17.3075 7.00089 17.1803 7.05357 17.0865 7.14734C16.9928 7.24111 16.9401 7.36829 16.9401 7.50089H17.9401ZM3.94008 7.50089C3.94008 7.36829 3.88741 7.24111 3.79364 7.14734C3.69987 7.05357 3.57269 7.00089 3.44008 7.00089C3.30748 7.00089 3.1803 7.05357 3.08653 7.14734C2.99276 7.24111 2.94008 7.36829 2.94008 7.50089H3.94008ZM19.0861 9.85489C19.18 9.94878 19.3073 10.0015 19.4401 10.0015C19.5729 10.0015 19.7002 9.94878 19.7941 9.85489C19.888 9.76101 19.9407 9.63367 19.9407 9.50089C19.9407 9.36812 19.888 9.24078 19.7941 9.14689L19.0861 9.85489ZM10.4401 0.500894L10.7941 0.146894C10.7476 0.100331 10.6925 0.0633878 10.6317 0.0381813C10.571 0.0129749 10.5059 0 10.4401 0C10.3743 0 10.3092 0.0129749 10.2485 0.0381813C10.1877 0.0633878 10.1325 0.100331 10.0861 0.146894L10.4401 0.500894ZM1.08608 9.14689C0.992198 9.24078 0.939453 9.36812 0.939453 9.50089C0.939453 9.63367 0.992198 9.76101 1.08608 9.85489C1.17997 9.94878 1.30731 10.0015 1.44008 10.0015C1.57286 10.0015 1.7002 9.94878 1.79408 9.85489L1.08608 9.14689ZM5.44008 19.0009H15.4401V18.0009H5.44008V19.0009ZM17.9401 16.5009V7.50089H16.9401V16.5009H17.9401ZM3.94008 16.5009V7.50089H2.94008V16.5009H3.94008ZM19.7941 9.14689L10.7941 0.146894L10.0861 0.854894L19.0861 9.85489L19.7941 9.14689ZM10.0861 0.146894L1.08608 9.14689L1.79408 9.85489L10.7941 0.854894L10.0861 0.146894ZM15.4401 19.0009C16.1031 19.0009 16.739 18.7375 17.2079 18.2687C17.6767 17.7998 17.9401 17.1639 17.9401 16.5009H16.9401C16.9401 16.8987 16.782 17.2802 16.5007 17.5616C16.2194 17.8429 15.8379 18.0009 15.4401 18.0009V19.0009ZM5.44008 18.0009C5.04226 18.0009 4.66073 17.8429 4.37942 17.5616C4.09812 17.2802 3.94008 16.8987 3.94008 16.5009H2.94008C2.94008 17.1639 3.20348 17.7998 3.67232 18.2687C4.14116 18.7375 4.77704 19.0009 5.44008 19.0009V18.0009Z" fill="white"/>
                        </svg>
                        <h5 className='text-white'> Home </h5>
                    </Link>
                    {user ? (
                    <Link className='nav-link' to={'/dashboard'}>
                        <svg width="20" height="21" viewBox="0 0 20 21" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M11.875 6.75V0.5H20V6.75H11.875ZM0 10.5V0.5H8.125V10.5H0ZM11.875 20.5V10.5H20V20.5H11.875ZM0 20.5V14.25H8.125V20.5H0ZM1.25 9.25H6.875V1.75H1.25V9.25ZM13.125 19.25H18.75V11.75H13.125V19.25ZM13.125 5.5H18.75V1.75H13.125V5.5ZM1.25 19.25H6.875V15.5H1.25V19.25Z" fill="white"/>
                        </svg>
                        <h5 className='text-white'> Dashboard </h5>
                    </Link>
                    ) : ( <></> )  }
                    <Link className='nav-link' to={'/settings'}>
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path fillRule="evenodd" clipRule="evenodd" d="M10 8.5C9.17157 8.5 8.5 9.17157 8.5 10C8.5 10.8284 9.17157 11.5 10 11.5C10.8284 11.5 11.5 10.8284 11.5 10C11.5 9.17157 10.8284 8.5 10 8.5ZM7.5 10C7.5 8.61929 8.61929 7.5 10 7.5C11.3807 7.5 12.5 8.61929 12.5 10C12.5 11.3807 11.3807 12.5 10 12.5C8.61929 12.5 7.5 11.3807 7.5 10Z" fill="white"/>
                        <path d="M3.39978 3.88004L3.64978 3.44604C3.55163 3.38929 3.4371 3.36758 3.32499 3.38448C3.21288 3.40138 3.10984 3.45588 3.03278 3.53904L3.39978 3.88004ZM1.40078 7.34404L0.922779 7.19604C0.889508 7.30425 0.893945 7.42055 0.935363 7.52591C0.97678 7.63127 1.05273 7.71945 1.15078 7.77604L1.40078 7.34404ZM1.39878 12.655L1.14878 12.222C1.05052 12.2787 0.974424 12.367 0.932994 12.4726C0.891563 12.5782 0.887256 12.6947 0.920779 12.803L1.39878 12.655ZM3.39878 16.119L3.03178 16.459C3.10884 16.5422 3.21188 16.5967 3.32399 16.6136C3.4361 16.6305 3.55063 16.6088 3.64878 16.552L3.39878 16.119ZM7.99878 18.774H7.49878C7.49872 18.8876 7.53731 18.9977 7.60819 19.0864C7.67907 19.1751 7.77803 19.2371 7.88878 19.262L7.99878 18.774ZM11.9998 18.776L12.1108 19.264C12.2213 19.2389 12.3201 19.1769 12.3908 19.0882C12.4614 18.9995 12.4999 18.8894 12.4998 18.776H11.9998ZM16.6008 16.12L16.3508 16.553C16.4489 16.6098 16.5635 16.6315 16.6756 16.6146C16.7877 16.5977 16.8907 16.5432 16.9678 16.46L16.6008 16.12ZM18.5988 12.654L19.0768 12.802C19.1101 12.6938 19.1056 12.5775 19.0642 12.4722C19.0228 12.3668 18.9468 12.2786 18.8488 12.222L18.5988 12.654ZM18.6008 7.34304L18.8508 7.77604C18.949 7.71941 19.0251 7.63106 19.0666 7.52548C19.108 7.41991 19.1123 7.30338 19.0788 7.19504L18.6008 7.34304ZM16.6008 3.87804L16.9678 3.53804C16.8907 3.45488 16.7877 3.40038 16.6756 3.38348C16.5635 3.36658 16.4489 3.38829 16.3508 3.44504L16.6008 3.87804ZM12.0008 1.22504H12.5008C12.5007 1.11181 12.4621 1.00198 12.3914 0.913508C12.3208 0.825039 12.2222 0.763175 12.1118 0.738038L12.0008 1.22504ZM8.00078 1.22304L7.88978 0.735038C7.77903 0.760016 7.68007 0.821944 7.60919 0.910636C7.53831 0.999328 7.49972 1.1095 7.49978 1.22304H8.00078ZM1.87878 7.49204C2.25429 6.2733 2.89921 5.15467 3.76578 4.21904L3.03278 3.53904C2.06391 4.58463 1.34276 5.83385 0.922779 7.19604L1.87878 7.49204ZM2.63878 14.25C2.32077 13.6997 2.06551 13.1153 1.87778 12.508L0.921779 12.804C1.13213 13.4825 1.41792 14.1353 1.77378 14.75L2.63878 14.25ZM3.76678 15.78C3.33511 15.3138 2.95608 14.8006 2.63878 14.25L1.77378 14.75C2.12822 15.3653 2.55053 15.9389 3.03278 16.46L3.76678 15.78ZM11.8898 18.29C10.6462 18.5728 9.35502 18.5721 8.11178 18.288L7.88978 19.262C9.27907 19.5797 10.722 19.5807 12.1118 19.265L11.8898 18.29ZM18.1228 12.508C17.7473 13.7268 17.1023 14.8454 16.2358 15.781L16.9688 16.461C17.9376 15.4154 18.6588 14.1652 19.0788 12.803L18.1228 12.508ZM17.3628 5.75004C17.6868 6.31304 17.9398 6.89704 18.1248 7.49204L19.0798 7.19604C18.8694 6.51756 18.5836 5.86481 18.2278 5.25004L17.3628 5.75004ZM16.2348 4.22004C16.6665 4.68631 17.0455 5.19952 17.3628 5.75004L18.2278 5.25004C17.8733 4.63478 17.451 4.0612 16.9688 3.54004L16.2348 4.22004ZM8.11178 1.71004C9.35532 1.42728 10.6465 1.42797 11.8898 1.71204L12.1118 0.738038C10.7225 0.420368 9.27952 0.419342 7.88978 0.735038L8.11178 1.71004ZM8.50078 3.07204V1.22204H7.50078V3.07204H8.50078ZM5.25078 4.37004L3.64978 3.44604L3.14978 4.31104L4.74978 5.23604L5.25078 4.37004ZM2.75078 11.298L1.14878 12.222L1.64978 13.088L3.24978 12.164L2.75078 11.298ZM3.25078 7.83404L1.65078 6.91104L1.15078 7.77704L2.75078 8.70004L3.25078 7.83404ZM8.50078 18.774V16.927H7.50078V18.774H8.50078ZM4.75078 14.762L3.14978 15.686L3.64978 16.552L5.24978 15.628L4.75078 14.762ZM16.8518 15.687L15.2508 14.762L14.7508 15.629L16.3508 16.553L16.8518 15.687ZM12.5008 18.777V16.927H11.5008V18.777H12.5008ZM18.3518 6.91004L16.7508 7.83404L17.2508 8.70004L18.8508 7.77604L18.3518 6.91004ZM18.8498 12.221L17.2508 11.3L16.7508 12.166L18.3508 13.089L18.8498 12.221ZM12.5008 3.07204V1.22504H11.5008V3.07204H12.5008ZM16.3518 3.44604L14.7508 4.37104L15.2508 5.23704L16.8518 4.31204L16.3518 3.44604ZM11.5008 3.07204C11.5008 4.99604 13.5838 6.19904 15.2508 5.23704L14.7508 4.37104C14.5227 4.50273 14.2639 4.57204 14.0005 4.572C13.7372 4.57196 13.4784 4.50256 13.2504 4.3708C13.0223 4.23903 12.833 4.04954 12.7014 3.82138C12.5698 3.59321 12.5006 3.33542 12.5008 3.07204H11.5008ZM16.7508 7.83504C15.0838 8.79704 15.0838 11.203 16.7508 12.165L17.2508 11.299C17.0228 11.1674 16.8334 10.978 16.7018 10.75C16.5702 10.522 16.5008 10.2633 16.5008 10C16.5008 9.73675 16.5702 9.47809 16.7018 9.25007C16.8334 9.02205 17.0228 8.8327 17.2508 8.70104L16.7508 7.83504ZM15.2508 14.763C13.5838 13.801 11.5008 15.002 11.5008 16.927H12.5008C12.5008 16.6637 12.5701 16.4061 12.7018 16.1781C12.8334 15.95 13.0228 15.7607 13.2508 15.629C13.4788 15.4974 13.7375 15.4281 14.0008 15.4281C14.2641 15.4281 14.5228 15.4974 14.7508 15.629L15.2508 14.763ZM8.50078 16.927C8.50078 15.003 6.41778 13.801 4.75078 14.763L5.25078 15.629C5.47888 15.4973 5.73763 15.428 6.00102 15.4281C6.26441 15.4281 6.52314 15.4975 6.7512 15.6293C6.97925 15.761 7.1686 15.9505 7.30018 16.1787C7.43176 16.4069 7.50095 16.6657 7.50078 16.929L8.50078 16.927ZM3.25078 12.165C4.91778 11.203 4.91778 8.79704 3.25078 7.83504L2.75078 8.70104C3.75078 9.27804 3.75078 10.72 2.75078 11.298L3.25078 12.165ZM7.50078 3.07204C7.5006 3.33526 7.43116 3.59379 7.29943 3.82167C7.1677 4.04956 6.97833 4.23877 6.75033 4.3703C6.52233 4.50183 6.26374 4.57105 6.00052 4.571C5.7373 4.57095 5.47873 4.50165 5.25078 4.37004L4.75078 5.23704C6.41778 6.19904 8.50078 4.99704 8.50078 3.07204H7.50078Z" fill="white"/>
                        </svg>
                        <h5 className='text-white'> Settings </h5>
                    </Link>
                    {user ? 
                        <>
                        <div className='nav-link'>
                            <svg className='cursor-pointer' width="20" height="22" viewBox="0 0 20 22" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M4.42846 2.00511C4.554453 1.85464 4.61659 1.66073 4.60129 1.46502C4.586 1.26931 4.49459 1.08739 4.34667 0.958325C4.19876 0.829259 4.00613 0.763332 3.81015 0.774696C3.61417 0.786061 3.43046 0.873812 3.29846 1.01911L2.00646 2.49911C1.27384 3.33868 0.859694 4.40908 0.836457 5.52311L0.779457 8.24211C0.777422 8.3406 0.794805 8.43853 0.830616 8.5303C0.866426 8.62208 0.919962 8.7059 0.988167 8.77698C1.05637 8.84806 1.13791 8.90502 1.22812 8.94459C1.31834 8.98416 1.41547 9.00558 1.51396 9.00761C1.61245 9.00965 1.71038 8.99226 1.80215 8.95645C1.89392 8.92064 1.97774 8.86711 2.04883 8.7989C2.11991 8.7307 2.17686 8.64916 2.21644 8.55894C2.25601 8.46873 2.27742 8.3716 2.27946 8.27311L2.33546 5.55511C2.3515 4.79284 2.63503 4.06047 3.13646 3.48611L4.42846 2.00511Z" fill="#fff"/>
                            <path fillRule="evenodd" clipRule="evenodd" d="M4.23793 7.2918C4.30508 6.22193 4.77745 5.21788 5.55885 4.48403C6.34025 3.75019 7.37196 3.34173 8.44393 3.3418H9.00093V2.5918C9.00093 2.32658 9.10628 2.07223 9.29382 1.88469C9.48136 1.69715 9.73571 1.5918 10.0009 1.5918C10.2661 1.5918 10.5205 1.69715 10.708 1.88469C10.8956 2.07223 11.0009 2.32658 11.0009 2.5918V3.3418H11.5579C12.6299 3.34173 13.6616 3.75019 14.443 4.48403C15.2244 5.21788 15.6968 6.22193 15.7639 7.2918L15.9849 10.8258C16.0704 12.173 16.5227 13.4712 17.2929 14.5798C17.4523 14.8089 17.5497 15.0753 17.5756 15.3531C17.6015 15.631 17.5551 15.9108 17.4408 16.1654C17.3266 16.4199 17.1484 16.6406 16.9236 16.8059C16.6988 16.9713 16.435 17.0756 16.1579 17.1088L12.7509 17.5168V18.5918C12.7509 19.3211 12.4612 20.0206 11.9455 20.5363C11.4297 21.0521 10.7303 21.3418 10.0009 21.3418C9.27158 21.3418 8.57211 21.0521 8.05638 20.5363C7.54066 20.0206 7.25093 19.3211 7.25093 18.5918V17.5168L3.84393 17.1078C3.56702 17.0745 3.30343 16.9702 3.07877 16.8049C2.85411 16.6396 2.67601 16.4191 2.56178 16.1647C2.44755 15.9102 2.40106 15.6306 2.42685 15.3529C2.45263 15.0752 2.5498 14.8088 2.70893 14.5798C3.47917 13.4712 3.93149 12.173 4.01693 10.8258L4.23793 7.2918ZM8.44393 4.8418C7.7535 4.84171 7.089 5.10477 6.58571 5.5774C6.08241 6.05004 5.77817 6.69673 5.73493 7.3858L5.51493 10.9198C5.41211 12.5405 4.86779 14.1023 3.94093 15.4358C3.92939 15.4524 3.92234 15.4716 3.92046 15.4917C3.91858 15.5118 3.92193 15.5321 3.93018 15.5505C3.93843 15.5689 3.95131 15.5849 3.96756 15.5968C3.98382 15.6088 4.00289 15.6164 4.02293 15.6188L7.75993 16.0678C9.24893 16.2458 10.7529 16.2458 12.2419 16.0678L15.9789 15.6188C15.999 15.6164 16.018 15.6088 16.0343 15.5968C16.0505 15.5849 16.0634 15.5689 16.0717 15.5505C16.0799 15.5321 16.0833 15.5118 16.0814 15.4917C16.0795 15.4716 16.0725 15.4524 16.0609 15.4358C15.1344 14.1022 14.5904 12.5404 14.4879 10.9198L14.2669 7.3858C14.2237 6.69673 13.9194 6.05004 13.4161 5.5774C12.9129 5.10477 12.2484 4.84171 11.5579 4.8418H8.44393ZM10.0009 19.8418C9.31093 19.8418 8.75093 19.2818 8.75093 18.5918V17.8418H11.2509V18.5918C11.2509 19.2818 10.6909 19.8418 10.0009 19.8418Z" fill="#fff"/>
                            <path d="M15.6435 0.946508C15.4937 1.07728 15.402 1.2622 15.3885 1.4606C15.3749 1.659 15.4408 1.85464 15.5715 2.00451L16.8635 3.48451C17.3648 4.05927 17.648 4.79202 17.6635 5.55451L17.7205 8.27151C17.7246 8.47042 17.8076 8.65955 17.9511 8.7973C18.0947 8.93504 18.2871 9.01012 18.486 9.00601C18.6849 9.0019 18.8741 8.91894 19.0118 8.77538C19.1495 8.63182 19.2246 8.43942 19.2205 8.24051L19.1635 5.52251C19.1403 4.40848 18.7261 3.33807 17.9935 2.49851L16.7015 1.01851C16.5707 0.868696 16.3858 0.776953 16.1874 0.763451C15.989 0.749949 15.7934 0.815794 15.6435 0.946508Z" fill="#fff"/>
                            </svg>
                            <h5 className='text-white cursor-pointer' onClick={() => setShowNotifs(!showNotifs)}>
                                Notifications
                            </h5>
                            {showNotifs && (
                                <div className="notif-lists">
                                    {notifications.length > 0 ? (
                                        notifications.map((notif, idx) => (
                                            <div key={idx} className="notification-item">
                                            <div
                                                className="notif-status"
                                                style={{ backgroundColor: getColor(notif.status) }}
                                            ></div>
                                            <div className="notif-message">
                                                <p>{notif.message}</p>
                                                <span>
                                                {notif.notificationDate
                                                    ? new Date(notif.notificationDate.seconds * 1000).toLocaleString()
                                                    : ""}
                                                </span>
                                            </div>
                                            </div>
                                        ))
                                    ) : (
                                    <p className="no-notifs">No notifications</p>
                                    )}
                                </div>
                            )}
                        </div>
                            <h5 className='text-white'>
                                {user.displayName && user.displayName.length > 6 
                                    ? `${user.displayName.substring(0, 6)}...` 
                                    : user.displayName || user.email}
                            </h5>
                            <button onClick={handleLogout} className="text-white">Logout</button>
                        </>
                     : 
                        // If user is not logged in, show the Signup link
                        <Link className='nav-link' to={'/signup'}>
                            <h5 className='normal text-white'> Signup </h5>
                        </Link>
                    }
                </div>
            </ul>
        </div>
    );
};

export default Navigation;
